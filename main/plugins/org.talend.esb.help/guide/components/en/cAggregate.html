<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>cAggregate</title><meta name="generator" content="DocBook XSL-NS Stylesheets V1.76.1"><link rel="home" href="index.html" title="Talend Open Studio"><link rel="up" href="ch06.html" title="Chapter&nbsp;6.&nbsp;Routing components"><link rel="prev" href="ch06.html" title="Chapter&nbsp;6.&nbsp;Routing components"><link rel="next" href="cDynamicRouter.html" title="cDynamicRouter"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div lang="EN" class="section" title="cAggregate"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="cAggregate"></a>cAggregate</h2></div></div></div><div class="mediaobject"><img src="../images/caggregate_icon32.png"></div><div class="section" title="cAggregate"><div class="titlepage"><div><div><h3 class="title"><a name="d0e10350"></a>cAggregate</h3></div></div></div><div class="informaltable"><table border="1"><colgroup><col class="c1"><col class="c2"><col class="c3"></colgroup><tbody><tr><td valign="top">
							<p>
								<span class="bold"><strong>Component Family</strong></span>
							</p>
						</td><td colspan="2" valign="top">
							<p>Routing</p>
						</td></tr><tr><td valign="top">
							<p>
								<span class="bold"><strong>Function</strong></span>
							</p>
						</td><td colspan="2" valign="top">
							<p><span class="bold"><strong>cAggregate</strong></span> aggregates messages
								together according to specified conditions.</p>
						</td></tr><tr><td valign="top">
							<p>
								<span class="bold"><strong>Purpose</strong></span>
							</p>
						</td><td colspan="2" valign="top">
							<p><span class="bold"><strong>cAggregate</strong></span> allows you to combine
								a number of messages together into a single message.</p>
						</td></tr><tr><td rowspan="8" valign="top">
							<p>
								<span class="bold"><strong>Basic settings</strong></span>
							</p>
							<p> </p>
							<p>&nbsp;</p>
						</td><td valign="top">
							<p>
								<span class="emphasis"><em>Language</em></span>
							</p>
						</td><td valign="top">Select the language of the expression you want to use to
							filter your messages, from <span class="bold"><strong>Constant</strong></span>,
								<span class="bold"><strong>EL</strong></span>, <span class="bold"><strong>Groovy</strong></span>, <span class="bold"><strong>Header</strong></span>,
								<span class="bold"><strong>Javascript</strong></span>, <span class="bold"><strong>JoSQL</strong></span>, <span class="bold"><strong>JXPath</strong></span>,
								<span class="bold"><strong>MVEL</strong></span>, <span class="bold"><strong>None</strong></span>, <span class="bold"><strong>OGNL</strong></span>, <span class="bold"><strong>PHP</strong></span>, <span class="bold"><strong>Property</strong></span>, <span class="bold"><strong>Python</strong></span>,
								<span class="bold"><strong>Ruby</strong></span>, <span class="bold"><strong>Simple</strong></span>, <span class="bold"><strong>SpEL</strong></span>, <span class="bold"><strong>SQL</strong></span>, <span class="bold"><strong>XPath</strong></span>,
							and <span class="bold"><strong>XQuery</strong></span>.</td></tr><tr><td valign="top">
							<p>
								<span class="emphasis"><em>Correlation expression/Expression</em></span>
							</p>
						</td><td valign="top">
							<p>Type in the expression that evaluates the correlation key to be
								used for the aggregation.</p>
						</td></tr><tr><td valign="top">
							<span class="emphasis"><em>Strategy</em></span>
						</td><td valign="top">Specify a Java bean to use as the aggregation
							strategy.</td></tr><tr><td valign="top">
							<span class="emphasis"><em>Completion conditions/Number of messages</em></span>
						</td><td valign="top">
							<p>Select this check box to specify the number of messages to
								aggregate per batch before the aggregation is complete.</p>
							<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="16pt"><img alt="[Note]" src="../images/note.png"></td><th align="left"></th></tr><tr><td align="left" valign="top"><p>By default, this check box is selected and the number of
									messages is set to <span class="italic">3</span>. If you
									clear this check box, and at least one of the other four
									completion conditions is met, all the messages retrieved will be
									aggregated in one batch.</p></td></tr></table></div>
						</td></tr><tr><td valign="top">
							<span class="emphasis"><em>Completion conditions/Inactivity timeout (in
								milliseconds)</em></span>
						</td><td valign="top">
							<p>Select this check box to specify the time (in milliseconds) that
								an aggregated exchange should be inactive before it is complete.
								This option can be set as either a fixed value or using an
								Expression which allows you to evaluate a timeout dynamically. </p>
							<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="16pt"><img alt="[Note]" src="../images/note.png"></td><th align="left"></th></tr><tr><td align="left" valign="top"><p>You can not use this option together with <span class="bold"><strong>Scheduled interval</strong></span>. Only one of them
									can be used at a time.</p></td></tr></table></div>
						</td></tr><tr><td valign="top">
							<span class="emphasis"><em>Completion conditions/Scheduled interval (in
								milliseconds)</em></span>
						</td><td valign="top">
							<p>Select this check box to specify a repeating period (in
								milliseconds) by which the aggregator will complete all current
								aggregated exchanges. </p>
							<div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="16pt"><img alt="[Note]" src="../images/note.png"></td><th align="left"></th></tr><tr><td align="left" valign="top"><p>You cannot use this option together with <span class="bold"><strong>Inactivity timeout</strong></span>. Only one of them can be used
									at a time.</p></td></tr></table></div>
						</td></tr><tr><td valign="top">
							<span class="emphasis"><em>Completion conditions/Predicate matched</em></span>
						</td><td valign="top">Select this check box to specify a predicate to indicate
							when an aggregated exchange is complete.</td></tr><tr><td valign="top">
							<span class="emphasis"><em>Completion conditions/Batch consumer</em></span>
						</td><td valign="top">Select this check box to aggregate all files consumed
							from a file endpoint in a given poll.</td></tr><tr><td rowspan="9" valign="top">
							<span class="bold"><strong>Advanced settings</strong></span>
						</td><td valign="top">
							<span class="emphasis"><em>Check completion before aggregating</em></span>
						</td><td valign="top">Select this check box to check for completion when a new
							incoming exchange has been received. This option influences the behavior
							of the <span class="bold"><strong>Predicate matched</strong></span> option as the
							exchange being passed in changes accordingly. When this option is
							disabled, the exchange passed in the predicate is the <span class="italic">aggregated</span> exchange which means any
							information you may store on the aggregated exchange from the
							aggregation strategy is available for the predicate. When this option is
							enabled, the exchange passed in the predicate is the <span class="italic">incoming</span> exchange, which means you can
							access data from the incoming exchange. </td></tr><tr><td valign="top">
							<span class="emphasis"><em>Close correlation group</em></span>
						</td><td valign="top">Select this check box to indicate that if a correlation
							key has already been completed, then any new exchanges with the same
							correlation key will be denied. When using this option, enter a number
							in the <span class="bold"><strong>Maximum bound</strong></span> field to keep that
							last number of closed correlation keys.</td></tr><tr><td valign="top">
							<span class="emphasis"><em>Ignore invalid correlation key</em></span>
						</td><td valign="top">Select this check box to ignore the invalid correlation
							key which could not be evaluated to a value. By default Camel will throw
							an Exception on encountering an invalid correlation key. </td></tr><tr><td valign="top">
							<span class="emphasis"><em>Group arriving exchange</em></span>
						</td><td valign="top">Select this check box to group all aggregated exchanges
							into a single combined holder class that holds all the aggregated
							exchanges. As a result only one exchange is being sent out from the
							aggregator. This option can be used to combine many incoming exchanges
							into a single output exchange.</td></tr><tr><td valign="top">
							<span class="emphasis"><em>Use persistence</em></span>
						</td><td valign="top">Select this check box to plug in your own implementation
							of the repository which keeps track of the current in-flight aggregated
							exchanges. By default, Camel uses a memory based implementation.</td></tr><tr><td valign="top">
							<span class="emphasis"><em>Repository</em></span>
						</td><td valign="top">This field appears when the <span class="bold"><strong>Use
								persistence</strong></span> check box is selected. The repository is
								<span class="bold"><strong>AggregationRepository</strong></span>, <span class="bold"><strong>HawtDBAggregationRepository</strong></span>, or <span class="bold"><strong>RecoverableAggregationRepository</strong></span>.</td></tr><tr><td valign="top">&nbsp;</td><td valign="top"><span class="bold"><strong>AggregationRepository</strong></span>:
							The default repository used by Camel which is a memory based
							implementation. Enter the name of the repository in the field.</td></tr><tr><td valign="top">&nbsp;</td><td valign="top">
							<p><span class="bold"><strong>HawtDBAggregationRepository</strong></span>:
								HawtDBAggregationRepository is an AggregationRepository which
								persists the aggregated messages on the fly. This ensures that you
								will not loose messages. With this repository selected, the
								following options appear:</p>
							<p><span class="bold"><strong>Use persistent file</strong></span>: Select this
								check box to store the aggregated exchanges in a file. Enter the
								name of the file for the persistent storage in the <span class="bold"><strong>Persistent file</strong></span> field. If the file does
								not exists on startup, it will be created. </p>
							<p><span class="bold"><strong>Recovery/Use recovery</strong></span>: Select
								this check box to recover failed aggregated exchanges and have them
								resubmitted automatically. In the <span class="bold"><strong>Recovery
									interval</strong></span> field, enter the interval (in milliseconds)
								to scan for failed exchanges to recover and resubmit. By default
								this interval is 5000 milliseconds. In the <span class="bold"><strong>Dead letter channel</strong></span> field, enter an endpoint URI for
								a Dead Letter Channel where exhausted recovered exchanges will be
								moved. In the <span class="bold"><strong>Maximum redeliveries</strong></span>
								field, enter the maximum number of redelivery attempts for a given
								recovered exchange.</p>
						</td></tr><tr><td valign="top">&nbsp;</td><td valign="top">
							<p><span class="bold"><strong>RecoverableAggregationRepository</strong></span>:
								RecoverableAggregationRepository is a JDBC based
								AggregationRepository which persists the aggregated messages on the
								fly. This ensures that you will not loose messages. Enter the name
								of the repository in the field.</p>
							<p>With this repository selected, the following options
								appear:</p>
							<p><span class="bold"><strong>Recovery/Use recovery</strong></span>: Select
								this check box to recover failed aggregated exchanges and have them
								resubmitted automatically. In the <span class="bold"><strong>Recovery
									interval</strong></span> field, enter the interval (in milliseconds)
								to scan for failed exchanges to recover and resubmit. By default
								this interval is 5000 milliseconds. In the <span class="bold"><strong>Dead letter channel</strong></span> field, enter an endpoint URI for
								a Dead Letter Channel where exhausted recovered exchanges will be
								moved. In the <span class="bold"><strong>Maximum redeliveries</strong></span>
								field, enter the maximum number of redelivery attempts for a given
								recovered exchange.</p>
						</td></tr><tr><td valign="top">
							<p>
								<span class="bold"><strong>Usage</strong></span>
							</p>
						</td><td colspan="2" valign="top">
							<p><span class="bold"><strong>cAggregate</strong></span> is used as a middle or
								end component in a Route.</p>
						</td></tr><tr><td rowspan="2" valign="top"><span class="bold"><strong>Connections</strong></span></td><td valign="top"><span class="emphasis"><em>Aggregate</em></span></td><td valign="top">Select this link to route messages to the next endpoint
							according to the selected aggregation strategy.</td></tr><tr><td valign="top"><span class="emphasis"><em>Route</em></span></td><td valign="top">Select this link to route all the messages from the
							sender to the next endpoint.</td></tr><tr><td valign="top">
							<span class="bold"><strong>Limitation</strong></span>
						</td><td colspan="2" valign="top">n/a</td></tr></tbody></table></div></div><div class="section" title="Scenario: Aggregating three messages into one"><div class="titlepage"><div><div><h3 class="title"><a name="d0e10758"></a>Scenario: Aggregating three messages into one</h3></div></div></div><p>In this scenario, the <span class="bold"><strong>cAggregate</strong></span> component combines
			three messages from the local file system into one and prints the messages in the
			console. A Java bean will be used as the aggregation strategy.</p><div class="section" title="Creating a Java bean as the aggregation strategy"><div class="titlepage"><div><div><h4 class="title"><a name="d0e10766"></a>Creating a Java bean as the aggregation strategy</h4></div></div></div><p>To aggregate the messages, we will use a Java bean that will help us build an
				aggregation strategy.</p><div class="procedure"><ol class="procedure" type="1"><li class="step" title="Step 1"><p> From the repository tree view, expand the <span class="bold"><strong>Code</strong></span> node and right click the <span class="bold"><strong>Beans</strong></span> node. In the contextual menu, select <span class="bold"><strong>Create Bean</strong></span>.</p><div class="mediaobject"><img src="../images/use_case_caggregate2.png"></div></li><li class="step" title="Step 2"><p> The <span class="bold"><strong>New Bean</strong></span> wizard opens. In the
							<span class="bold"><strong>Name</strong></span> field, type in a name for the
						bean, for example, <span class="emphasis"><em>AggregateBody</em></span>. Click <span class="bold"><strong>Finish</strong></span> to close the wizard.</p><div class="mediaobject"><img src="../images/use_case_caggregate3.png"></div></li><li class="step" title="Step 3"><p> Type in the codes as shown in the figure below. In this use case, we just
						want to aggregate all messages into a single message.</p><p>
						</p><pre class="programlisting">package beans;

import org.apache.camel.Exchange;
import org.apache.camel.processor.aggregate.AggregationStrategy;

public class AggregateBody implements AggregationStrategy{

	public Exchange aggregate(Exchange oldEx, Exchange newEx) {
		if(oldEx==null){
			return newEx;
		}
		String oldBody = oldEx.getIn().getBody(String.class);
		String newBody = newEx.getIn().getBody(String.class);
		newEx.getIn().setBody(oldBody+newBody);
		return newEx;
	}
}</pre><p>
					</p></li><li class="step" title="Step 4"><p> Press <span class="bold"><strong>Ctrl+S</strong></span> to save your bean.</p></li></ol></div></div><div class="section" title="Dropping and linking the components"><div class="titlepage"><div><div><h4 class="title"><a name="d0e10819"></a>Dropping and linking the components</h4></div></div></div><div class="mediaobject"><img src="../images/use_case_caggregate1.png"></div><div class="procedure"><ol class="procedure" type="1"><li class="step" title="Step 1"><p>From the <span class="bold"><strong>Palette</strong></span>, expand the <span class="bold"><strong>Messaging</strong></span> folder, and drop a <span class="bold"><strong>cFile</strong></span> component onto the design workspace.</p></li><li class="step" title="Step 2"><p>Expand the <span class="bold"><strong>Routing</strong></span> folder, and drop a
							<span class="bold"><strong>cAggregate</strong></span> component onto the design
						workspace.</p></li><li class="step" title="Step 3"><p>Expand the <span class="bold"><strong>Processor</strong></span> folder, and drop two
							<span class="bold"><strong>cProcessor</strong></span> components onto the design
						workspace.</p></li><li class="step" title="Step 4"><p>Right-click the <span class="bold"><strong>cFile</strong></span> component, select
							<span class="bold"><strong>Row</strong></span> &gt; <span class="bold"><strong>Route</strong></span> from the contextual menu and click the first <span class="bold"><strong>cProcessor</strong></span> component.</p></li><li class="step" title="Step 5"><p>Repeat this operation to connect the first <span class="bold"><strong>cProcessor</strong></span> component to the <span class="bold"><strong>cAggregate</strong></span> component. </p></li><li class="step" title="Step 6"><p>Right-click the <span class="bold"><strong>cAggregate</strong></span> component,
						select <span class="bold"><strong>Row</strong></span> &gt; <span class="bold"><strong>Aggregate</strong></span> from the contextual menu and click the second
							<span class="bold"><strong>cProcessor</strong></span> component.</p></li><li class="step" title="Step 7"><p>Label all the components to better identify their functionality, as shown
						above.</p></li></ol></div></div><div class="section" title="Configuring the components"><div class="titlepage"><div><div><h4 class="title"><a name="d0e10898"></a>Configuring the components</h4></div></div></div><div class="procedure"><ol class="procedure" type="1"><li class="step" title="Step 1"><p>Double-click the <span class="bold"><strong>cFile</strong></span> component, which
						is labelled <span class="italic">File_source</span>, to display its
							<span class="bold"><strong>Basic settings</strong></span> view in the <span class="bold"><strong>Component</strong></span> tab.</p><div class="mediaobject"><img src="../images/use_case_caggregate5.png"></div></li><li class="step" title="Step 2"><p>In the <span class="bold"><strong>Path</strong></span> field, browse to or enter the
						input file path, and leave the other parameters as they are. </p><p>In this scenario, there are four text files in the specified directory:
							<span class="emphasis"><em>a.txt</em></span>, <span class="emphasis"><em>b.txt</em></span>,
							<span class="emphasis"><em>c.txt</em></span> and <span class="emphasis"><em>d.txt</em></span>, the contents
						of which are <span class="emphasis"><em>This is a! </em></span>, <span class="emphasis"><em>This is b!
						</em></span>, <span class="italic">This is c! </span>, and
							<span class="emphasis"><em>This is d! </em></span> respectively.</p></li><li class="step" title="Step 3"><p>Double-click the <span class="bold"><strong>cAggregate</strong></span> component,
						which is labelled <span class="italic">Aggregator</span>, to display
						its <span class="bold"><strong>Basic settings</strong></span> view in the <span class="bold"><strong>Component</strong></span> tab.</p><div class="mediaobject"><img src="../images/use_case_caggregate6.png"></div></li><li class="step" title="Step 4"><p>In the <span class="bold"><strong>Language</strong></span> field, select <span class="bold"><strong>Constant</strong></span> or <span class="bold"><strong>Simple</strong></span> as the expression language.</p><p>In the <span class="bold"><strong>Expression</strong></span> field, enter the expression <code class="code">"getBody(String.class)"</code> to retrieve the body of the message.</p><p>In the <span class="bold"><strong>Strategy</strong></span> field, enter the name of the Java bean <span class="emphasis"><em>AggregateBody</em></span> you just created.</p><p>Select the <span class="bold"><strong>Number of messages</strong></span> check box and type in <span class="emphasis"><em>2</em></span> in the field.</p></li><li class="step" title="Step 5"><p>Double-click the <span class="bold"><strong>cProcessor</strong></span> component
						labelled <span class="italic">Monitor_before</span> to display its
							<span class="bold"><strong>Basic settings</strong></span> view in the <span class="bold"><strong>Component</strong></span> tab. </p><div class="mediaobject"><img src="../images/use_case_caggregate7.png"></div></li><li class="step" title="Step 6"><p>In the <span class="bold"><strong>Code</strong></span> box, customize the code as
						follows so that the <span class="bold"><strong>Run</strong></span> console displays
						the message contents before an aggregation takes place:</p><p>
						</p><pre class="programlisting">System.out.println("Before aggregation: "+
exchange.getIn().getBody(String.class));</pre><p>
					</p></li><li class="step" title="Step 7"><p>In the same way, configure the <span class="bold"><strong>cProcessor</strong></span>
						component labelled <span class="italic">Monitor_after</span> so that
						the Run console displays the message contents after an aggregation takes
						place: </p><p>
						</p><pre class="programlisting">System.out.println("After aggregation: "+
exchange.getIn().getBody(String.class));</pre><p>
					</p></li><li class="step" title="Step 8"><p> Press <span class="bold"><strong>Ctrl+S</strong></span> to save your route.</p></li></ol></div></div><div class="section" title="Viewing code and executing the Route"><div class="titlepage"><div><div><h4 class="title"><a name="d0e11058"></a>Viewing code and executing the Route</h4></div></div></div><div class="procedure"><ol class="procedure" type="1"><li class="step" title="Step 1"><p>Click the <span class="bold"><strong>Code</strong></span> tab at the bottom of the
						design workspace to have a look at the generated code.</p><div class="mediaobject"><img src="../images/use_case_caggregate9.png"></div><p>As shown in the code, a message <code class="code">from</code> the
							<code class="code">File_source</code> endpoint is routed via
							<code class="code">cProcessor_1</code> and then aggregated according to the condition
							<code class="code">.aggregate</code>.</p></li><li class="step" title="Step 2"><p>Click the <span class="bold"><strong>Run</strong></span> view to display it and
						click the <span class="bold"><strong>Run</strong></span> button to launch the
						execution of your route. You can also press <span class="bold"><strong>F6</strong></span> to execute it. </p><p>RESULT: The four messages are aggregated in two batches, two messages
						combined into one each batch. </p><div class="mediaobject"><img src="../images/use_case_caggregate10.png"></div></li></ol></div></div></div></div></body></html>